<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b3c2f" />
  <link rel="manifest" href="manifest.json" />
  <link rel="icon" type="image/png" sizes="32x32" href="icons/icon-512.png">
  <link rel="apple-touch-icon" href="icons/icon-512.png">
  <title>Kerala Fuel Prices</title>

  <style>
    /* DARK MODE ONLY */
    :root{
      --bg: #071011;
      --card: #081718;
      --muted: #98a3a3;
      --accent: #06a37a;
      --glass: rgba(255,255,255,0.03);
      --radius: 14px;
    }
    html,body{height:100%}
    body{
      margin:0;
      background: #000;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      color: #e6f0ee;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      padding:28px 12px;
    }

    header{
      width:100%;
      max-width:720px;
      display:flex;
      align-items:center;
      gap:14px;
      margin-bottom:18px;
    }
    header img{
      width:56px;height:56px;border-radius:12px;object-fit:cover;
      box-shadow: 0 6px 18px rgba(0,0,0,0.6), inset 0 1px 0 rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.02);
      background: linear-gradient(135deg, rgba(255,255,255,0.02), transparent);
    }
    header h1{margin:0;font-size:1.15rem;font-weight:600;letter-spacing:-0.2px}
    header p{margin:0;color:var(--muted);font-size:.86rem}

    .wrap{width:100%;max-width:720px}
    .card{
      background: linear-gradient(180deg,var(--card), rgba(8,23,23,0.9));
      border-radius:var(--radius);
      padding:18px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.6);
      border: 1px solid rgba(255,255,255,0.02);
    }

    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    label{font-size:.85rem;color:var(--muted)}
    select {
      background: var(--glass);
      border:1px solid rgba(255,255,255,0.03);
      color: #e6f0ee;
      padding:10px 12px;border-radius:10px;font-size:1rem;
      outline:none;
    }

    .prices{display:flex;gap:18px;margin-top:16px;align-items:flex-end;flex-wrap:wrap}
    .tile{
      background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));
      padding:14px 16px;border-radius:12px;min-width:170px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,0.02);
      border:1px solid rgba(255,255,255,0.02);
    }
    .tile .label{font-size:.85rem;color:var(--muted);margin-bottom:6px}
    .tile .value{font-size:1.8rem;font-weight:700;color:#fff}
    .tile .sub{font-size:.86rem;color:var(--muted);margin-top:8px}

    .muted{color:var(--muted);font-size:.92rem;margin-top:12px}

    button{
      margin-top:14px;background: linear-gradient(180deg,var(--accent), #048b67);
      border:none;color:white;padding:10px 14px;border-radius:10px;
      cursor:pointer;font-weight:600;font-size:0.98rem;box-shadow: 0 6px 18px rgba(6,163,122,0.14);
    }

    /* shimmer loader */
    .shimmer { position:relative; overflow:hidden; background:linear-gradient(90deg,#0b2a25 0%, #0c3b33 50%, #0b2a25 100%); }
    .shimmer::after{ content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg, transparent, rgba(255,255,255,0.03), transparent);animation: shine 1.2s infinite;}
    @keyframes shine{ to { transform: translateX(100%); } }

    @media (max-width:520px){ .prices{flex-direction:column} .tile{min-width:100%} }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <img src="icons/icon-home.png" alt="logo" />
      <div>
        <h1>Kerala Fuel Prices</h1>
        <p>Prices update every morning.</p>
      </div>
    </header>

    <div class="card" role="main" aria-live="polite">
      <div class="row" style="justify-content:space-between;">
        <div>
          <label for="district">District</label><br />
          <select id="district" aria-label="Select district">
            <option value="alappuzha">Alappuzha</option>
            <option value="kakkanad">Kakkanad</option>
            <option value="kalpetta">Kalpetta</option>
            <option value="kannur">Kannur</option>
            <option value="kasaragod">Kasaragod</option>
            <option value="kollam">Kollam</option>
            <option value="kottayam">Kottayam</option>
            <option value="kozhikode">Kozhikode</option>
            <option value="malappuram">Malappuram</option>
            <option value="palakkad" selected>Palakkad</option>
            <option value="pandakkal">Pandakkal</option>
            <option value="pathanamthitta">Pathanamthitta</option>
            <option value="thrissur">Thrissur</option>
            <option value="trivandrum">Trivandrum</option>
          </select>
        </div>

        <div style="text-align:right">
          <div id="status" class="muted">Loading latest prices…</div>
        </div>
      </div>

      <div class="prices" id="pricesArea" aria-hidden="true">
        <div class="tile">
          <div class="label">Petrol</div>
          <div id="petrol" class="value shimmer" style="height:42px;width:110px;border-radius:6px"></div>
          <div class="sub" id="petrol-sub"></div>
        </div>

        <div class="tile">
          <div class="label">Diesel</div>
          <div id="diesel" class="value shimmer" style="height:42px;width:110px;border-radius:6px"></div>
          <div class="sub" id="diesel-sub"></div>
        </div>
      </div>

      <div class="muted" id="updatedText">Last update: —</div>

      <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
        <button id="refresh">Refresh</button>
      </div>
    </div>
  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  // === config ===
  const FALLBACK = {
    alappuzha: "kollam",
    kakkanad: "thrissur",
    kalpetta: "palakkad",
    kannur: "kollam",
    kasaragod: "palakkad",
    kollam: "kollam",
    kottayam: "kollam",
    kozhikode: "palakkad",
    malappuram: "palakkad",
    palakkad: "palakkad",
    pandakkal: "thrissur",
    pathanamthitta: "kollam",
    thrissur: "thrissur",
    trivandrum: "kollam"
  };

  // Utilities
  function pricesUrl(){ return 'prices.json?t=' + Date.now(); }

  function toIST(isoString){
    try{
      const d = new Date(isoString);
      return d.toLocaleString('en-IN', { timeZone: 'Asia/Kolkata', hour12: true });
    }catch(e){ return isoString; }
  }

  // shimmer helpers
  function showShimmer(){
    document.getElementById('petrol').classList.add('shimmer');
    document.getElementById('diesel').classList.add('shimmer');
    document.getElementById('petrol').textContent = '';
    document.getElementById('diesel').textContent = '';
    document.getElementById('pricesArea').setAttribute('aria-hidden','true');
    document.getElementById('status').textContent = 'Loading latest prices…';
  }
  function hideShimmer(){
    document.getElementById('petrol').classList.remove('shimmer');
    document.getElementById('diesel').classList.remove('shimmer');
    document.getElementById('pricesArea').removeAttribute('aria-hidden');
  }

  // Extractor: accepts flat or per-district shape
  function extractForDistrict(data, slug){
    // flat object
    if (data && typeof data.petrol === 'number' && typeof data.diesel === 'number') {
      return { petrol: data.petrol, diesel: data.diesel, updated_at: data.updated_at || new Date().toISOString() };
    }
    // per-district object (case-insensitive)
    if (data && typeof data === 'object') {
      const lk = slug.toLowerCase();
      for (const k of Object.keys(data)){
        if (k.toLowerCase() === lk){
          const item = data[k];
          if (item && (item.petrol !== undefined || item.diesel !== undefined)) {
            return { petrol: Number(item.petrol), diesel: Number(item.diesel), updated_at: item.updated_at || new Date().toISOString() };
          }
        }
      }
    }
    return null;
  }

  // load and render
  async function loadPricesFor(slug){
    showShimmer();
    try{
      const res = await fetch(pricesUrl(), { cache: 'no-store', credentials: 'same-origin' });
      if (!res.ok) throw new Error('network error: ' + res.status);
      const data = await res.json();

      // if requested slug missing, try direct slug, then fallback
      let item = extractForDistrict(data, slug);
      if (!item){
        const fb = FALLBACK[slug] || 'palakkad';
        item = extractForDistrict(data, fb);
        if (item) slug = fb;
      }

      if (!item){
        document.getElementById('status').textContent = 'No data for ' + slug + ' (showing cached if available)';
        const cached = localStorage.getItem('prices_v1');
        if (cached){
          const parsed = JSON.parse(cached);
          const cachedItem = extractForDistrict(parsed, slug);
          if (cachedItem) { render(cachedItem, slug, true); return; }
        }
        renderMissing(slug);
        return;
      }

      // save raw for fallback
      localStorage.setItem('prices_v1', JSON.stringify(data));
      render(item, slug, false);
    }catch(err){
      const cached = localStorage.getItem('prices_v1');
      if (cached){
        const parsed = JSON.parse(cached);
        const cachedItem = extractForDistrict(parsed, slug);
        if (cachedItem) { render(cachedItem, slug, true); return; }
      }
      renderMissing(slug, err);
    }
  }

  function render(item, slug, fromCache){
    hideShimmer();
    document.getElementById('petrol').textContent = '₹' + Number(item.petrol).toFixed(2);
    document.getElementById('diesel').textContent = '₹' + Number(item.diesel).toFixed(2);
    const label = slug.charAt(0).toUpperCase() + slug.slice(1);
    document.getElementById('petrol-sub').textContent = label;
    document.getElementById('diesel-sub').textContent = label;
    document.getElementById('updatedText').textContent = 'Last update: ' + toIST(item.updated_at) + (fromCache ? ' (cached)' : '');
    document.getElementById('status').textContent = fromCache ? 'Showing cached data' : 'Latest';
  }

  function renderMissing(slug, err){
    hideShimmer();
    document.getElementById('petrol').textContent = '—';
    document.getElementById('diesel').textContent = '—';
    document.getElementById('petrol-sub').textContent = '';
    document.getElementById('diesel-sub').textContent = '';
    document.getElementById('updatedText').textContent = 'No data for ' + slug;
    document.getElementById('status').textContent = err ? String(err) : 'No data';
  }

  // --- district control wiring ---
  const sel = document.getElementById('district');
  function chosenSlug(){ return sel && sel.value ? sel.value.toLowerCase() : 'palakkad'; }
  function resolveSlug(slug){
    if (!slug) return 'palakkad';
    try {
      const raw = localStorage.getItem('prices_v1');
      if (raw){
        const parsed = JSON.parse(raw);
        if (parsed && parsed[slug] && parsed[slug].petrol !== undefined) return slug;
      }
    } catch(e){}
    return FALLBACK[slug] || 'palakkad';
  }

  async function refresh(){
    const requested = chosenSlug();
    const safe = resolveSlug(requested);
    await loadPricesFor(safe);
  }

  sel.addEventListener('change', refresh);
  document.getElementById('refresh').addEventListener('click', refresh);

  // register service worker and ask it to check for updates
  if ('serviceWorker' in navigator){
    navigator.serviceWorker.register('sw.js').then(reg=>{
      if (reg && reg.update) reg.update();
    }).catch(()=>{/* ignore */});
  }

  // initial load
  refresh();
});
</script>

</body>
</html>
